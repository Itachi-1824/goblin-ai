name: Build Platform Wheels

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 1.1.0)'
        required: true
        default: '1.1.0'

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
          - os: macos-latest
            platform: macos

    runs-on: ${{ matrix.os }}
    name: Build ${{ matrix.platform }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install build tools
        run: pip install nuitka ordered-set zstandard wheel setuptools

      - name: Decrypt source files
        env:
          SOURCE_1: ${{ secrets.GOBLIN_SOURCE_1 }}
          SOURCE_2: ${{ secrets.GOBLIN_SOURCE_2 }}
        run: |
          echo "${SOURCE_1}${SOURCE_2}" | base64 -d | xz -d > source.tar
          tar -xf source.tar -C goblin/
          rm source.tar
          ls -la goblin/*.py

      - name: Compile with Nuitka
        run: |
          for module in _core _guard easy generator models parameters server prompts; do
            echo "Compiling $module..."
            python -m nuitka --module goblin/${module}.py --output-dir=goblin --remove-output
          done

      - name: Remove source files
        run: |
          rm -f goblin/_core.py goblin/_guard.py goblin/easy.py goblin/generator.py
          rm -f goblin/models.py goblin/parameters.py goblin/server.py goblin/prompts.py
          rm -f goblin/*.pyi
          ls -la goblin/

      - name: Build wheel
        run: pip wheel . --no-deps -w dist/

      - name: List wheel
        run: ls -la dist/

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: wheel-${{ matrix.platform }}
          path: dist/*.whl
